#!/bin/bash

if [[ $# != 1 ]]; then
  devbox_info "No version given, assuming this is a development build."
  devbox_info "To create a release build, run this command with a version argument."
  devbox_image_tag="$devbox_image:latest"
elif ! git tag --points-at HEAD | grep --quiet "^$1$"; then
  devbox_error "Tried to build release for version $1, but no such tag points at HEAD."
  devbox_error "To make a release build, HEAD must have a matching version tag."
  exit 1
else
  devbox_info "Building release image for version $1"
  devbox_image_tag="$devbox_image:$1"
fi

devbox_docker build                    \
     --build-arg DEVBOX_UID="$(id -u)" \
     --build-arg DEVBOX_GID="$(id -g)" \
     --tag "$devbox_image_tag"         \
     "$devbox_repo_dir"/docker
