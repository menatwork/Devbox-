#!/bin/bash
#
# devbox -- core devbox CLI shell script
#
# This script sets up the environment and provides functions for other
# scripts in the bin directory (_build, _run, etc), which are not
# meant to be called directly.
#
# Regarding functions in this file:
#
# All functions prefixed with a _ are not meant to be used outside of
# this file. Command scripts (bin/_*) should only use functions
# prefixed with "devbox_".
#
set -euo pipefail

# -- Command script functions --------------------------------------------------

# Run a Docker command through the appropriate wrapper, if any.
#
# When we're running on Windows in Git bash, we need to call docker
# through winpty to provide an interactive terminal.
devbox_docker() {
  case "$devbox_os" in
    # Window/git bash
    Msys) winpty docker "$@" ;;

    # Probably Linux or macOS
    *) docker "$@" ;;
  esac
}

# Print an info message.
devbox_info() {
  if [[ -v _scriptname ]]; then
    printf "\e[1;96m==> devbox %s:\e[0;96m %s\e[0m\n" "$_scriptname" "$@"
  else
    printf "\e[1;96m==> devbox:\e[0;96m %s\e[0m\n" "$@"
  fi
}

# Print an error message.
devbox_error() {
  if [[ -v _scriptname ]]; then
    >&2 printf "\e[1;31m==> devbox %s:\e[0;31m %s\e[0m\n" "$_scriptname" "$@"
  else
    >&2 printf "\e[1;31m==> devbox:\e[0;31m %s\e[0m\n" "$@"
  fi
}

# Translate $PWD to its corresponding path in the devbox container.
#
# This will print an error and exit with status code 1 if $PWD isn't
# in $devbox_projects_dir.
devbox_pwd_in_container() {
  local real_projects_dir="$(_path_windows_to_unix "$devbox_projects_dir")"

  if [[ ! "$PWD" =~ ^"$real_projects_dir" ]]; then
      devbox_error "you are not in $devbox_projects_dir"
      exit 1
  fi

  printf %s "/projects/${PWD/#$real_projects_dir\/}"
}

# Return 0 if the devbox container is running, 1 otherwise.
devbox_is_running() {
  docker inspect -f '{{.State.Running}}' "$devbox_container" \
	 >/dev/null 2>/dev/null
}

# -- Internal functions --------------------------------------------------------

# Translate Windows-style paths into Msys format.
#
# E.g., C:\Public\Foobar → /c/Public/Foobar
#
# Paths are returned unchanged if they don't start with "C:\".
_path_windows_to_unix() {
  if [[ "$1" =~ ^C:\\ ]]; then
      local result="$1"

      result="${1/#C:/\/c}"      # replace "C:" with "/c"
      result="${result//\\/\/}"  # replace all "\" with "/"

      set -- "$result"
  fi

  printf %s "$1"
}

# Translate Msys-style file system paths to Windows paths.
#
# E.g., /c/Public/Foobar → C:\Public\Foobar
#
# Paths are returned unchanged if they don't start with /c/.
_path_unix_to_windows() {
  if [[ "$1" =~ ^/c/ ]]; then
      local result="$1"

      result="${result/#\/c/C:}"  # replace "/c" with "C:"
      result="${result//\//\\/}"  # replace all "/" with "\"

      set -- "$result"
  fi

  printf %s "$1"
}

# (satellite function for _main)
# Sources the repo's ".env" file if it exists.
_main_load_dot_env() {
  local env_file="$devbox_repo_dir"/.env

  if [[ -f "$env_file" ]]; then
    . "$env_file"
  fi
}

# The script entry point. This sets up shell variables and defers
# execution to the appropriate command script.
_main() {
  _script_dir="$(dirname "$0")"

  if [[ $# -lt 1 ]]; then
      devbox_error "missing command"
      . "$_script_dir"/_help
      exit 1
  fi

  _scriptname="$1"
  _script="$_script_dir/_$1"

  if [[ ! -f "$_script" ]]; then
      devbox_error "command not found"
      . "$_script_dir"/_help
      exit 1
  fi

  shift

  devbox_os="$(uname -o)"

  # Non-configurable directories
  devbox_repo_dir="$(realpath "$_script_dir"/..)"
  devbox_shell_dir="$(_path_unix_to_windows "$devbox_repo_dir"/shell)"

  _main_load_dot_env

  devbox_docker_registry=gitlab.men-at-work.de:4774

  devbox_container=devbox
  devbox_image="$devbox_docker_registry"/entwicklung/devbox
  devbox_image_tag="$devbox_image":latest

  # Names of Docker volumes for persistent data
  devbox_volume_mysql=devbox-mysql
  devbox_volume_sessions=devbox-sessions
  devbox_volume_cache=devbox-cache

  if [[ "$_scriptname" != setup ]]; then
      # Configurable directories
      devbox_projects_dir="${devbox_projects_dir:-$(realpath "$script_dir"/../..)}"
      devbox_ssh_dir="$devbox_ssh_dir"
  fi

  . "$_script"
}

_main "$@"
