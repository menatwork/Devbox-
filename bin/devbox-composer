#!/bin/bash
set -eu

DEVBOX_IMAGE=devbox
DEVBOX_WEB_ROOT="$HOME/code"

if [[ ! "$PWD" =~ ^"$DEVBOX_WEB_ROOT" ]]; then
    >&2 echo "$(basename "$0"): error: you are not in DEVBOX_WEB_ROOT!"
    exit 1
fi

pwd_in_container="/projects/${PWD/#$DEVBOX_WEB_ROOT\/}"

docker run					\
       --interactive				\
       --tty					\
       --workdir="$pwd_in_container"		\
       --user=www-data				\
       --volume="$DEVBOX_WEB_ROOT:/projects"    \
       --volume="$HOME/.cache/devbox/composer:/var/www/.composer/cache" \
       --volume="$SSH_AUTH_SOCK:/.ssh-agent"	\
       --env "SSH_AUTH_SOCK=/.ssh-agent"	\
       "$DEVBOX_IMAGE"			        \
       composer "$@"
